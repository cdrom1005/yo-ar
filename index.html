const assetContainer = document.querySelector("#assets-list");
const targetsContainer = document.querySelector("#targets-container");
const uiOverlay = document.querySelector("#ui-overlay");
const startBtn = document.querySelector("#start-btn");
const statusText = document.querySelector("#status");
const scanGuide = document.querySelector("#scan-guide");
const sceneEl = document.querySelector("#ar-scene");

const TOTAL = 7;
let loadedCount = 0;

// 1. 生成 .mind 檔案列表路徑
const mindFiles = Array.from({length: TOTAL}, (_, i) => `./${(i+1).toString().padStart(2, '0')}.mind`).join('; ');

// 2. 將 autoStart 改為 false，避免網頁一打開就搶相機權限導致失敗
sceneEl.setAttribute('mindar-image', `imageTargetSrc: ${mindFiles}; autoStart: false; uiScanning: no; uiLoading: no;`);

// 3. 生成資源
for (let i = 1; i <= TOTAL; i++) {
    const id = i.toString().padStart(2, '0');

    // Video 資源
    const video = document.createElement('video');
    video.id = `v-${id}`;
    video.src = `./${id}.mp4`;
    video.setAttribute('preload', 'auto');
    video.setAttribute('loop', 'true');
    video.setAttribute('crossorigin', 'anonymous');
    video.setAttribute('webkit-playsinline', '');
    video.setAttribute('playsinline', '');
    video.muted = true;
    assetContainer.appendChild(video);

    // Target 實體
    const targetEntity = document.createElement('a-entity');
    targetEntity.setAttribute('mindar-image-target', `targetIndex: ${i-1}`);
    
    const videoEntity = document.createElement('a-video');
    videoEntity.id = `ent-${id}`;
    videoEntity.setAttribute('src', `#v-${id}`);
    videoEntity.setAttribute('width', '1');
    videoEntity.setAttribute('height', '1');
    
    targetEntity.appendChild(videoEntity);
    targetsContainer.appendChild(targetEntity);

    video.addEventListener('loadedmetadata', () => {
        const aspect = video.videoHeight / video.videoWidth;
        videoEntity.setAttribute('height', aspect);
        loadedCount++;
        statusText.innerText = `資源載入中 (${loadedCount}/${TOTAL})...`;
        if (loadedCount === TOTAL) {
            document.getElementById("loader").style.display = "none";
            statusText.innerText = "全部就緒，請開啟相機";
            startBtn.style.display = "block";
        }
    });

    targetEntity.addEventListener("targetFound", () => {
        scanGuide.style.display = "none";
        video.muted = false;
        video.play();
    });

    targetEntity.addEventListener("targetLost", () => {
        scanGuide.style.display = "block";
        video.pause();
    });
}

// 4. 修改後的啟動按鈕邏輯
startBtn.addEventListener('click', () => {
    // A. 隱藏 UI
    uiOverlay.style.display = "none";
    scanGuide.style.display = "block";
    
    // B. 手動啟動 MindAR 系統 (這能解決黑屏問題)
    const arSystem = sceneEl.systems['mindar-image-system'];
    if (arSystem) {
        arSystem.start(); 
    }

    // C. 解鎖影片播放
    const allVideos = document.querySelectorAll('video');
    allVideos.forEach(v => {
        v.play().then(() => {
            v.pause();
            v.currentTime = 0;
        }).catch(e => console.error("Video Unlock Error:", e));
    });
});
