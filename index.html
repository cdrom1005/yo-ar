<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }

    #ui-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #111; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 10000;
    }

    #start-btn {
      padding: 15px 40px; background: #007AFF; color: white;
      border: none; border-radius: 30px; font-size: 18px;
      cursor: pointer; display: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    .loader {
      border: 4px solid #333; border-top: 4px solid #007AFF;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #scan-guide {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 250px; height: 250px; border: 2px dashed rgba(255,255,255,0.5);
      border-radius: 20px; display: none; z-index: 9000; pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="ui-overlay">
    <div class="loader" id="loader"></div>
    <p id="status" style="color: white; margin-top: 15px;">è³‡æºè¼‰å…¥ä¸­ (0/7)...</p>
    <button id="start-btn">é–‹å§‹æƒæ</button>
  </div>

  <div id="scan-guide"></div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; uiScanning: no; uiLoading: no;"
    renderer="antialias: true; precision: highp; colorManagement: true;"
    color-space="sRGB"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets id="assets-list"></a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- âœ… é‡è¦ï¼šç”¨ a-entity ç•¶å®¹å™¨ï¼Œä¸è¦ç”¨ div -->
    <a-entity id="targets-container"></a-entity>
  </a-scene>

  <script>
    const assetContainer = document.querySelector("#assets-list");
    const targetsContainer = document.querySelector("#targets-container");
    const uiOverlay = document.querySelector("#ui-overlay");
    const startBtn = document.querySelector("#start-btn");
    const statusText = document.querySelector("#status");
    const scanGuide = document.querySelector("#scan-guide");
    const loader = document.querySelector("#loader");

    const TOTAL = 7;
    let loadedCount = 0;
    let unlocked = false;

    const checkReady = () => {
      loadedCount++;
      statusText.innerText = `è³‡æºè¼‰å…¥ä¸­ (${loadedCount}/${TOTAL})...`;
      if (loadedCount >= TOTAL) {
        loader.style.display = "none";
        statusText.innerText = "æº–å‚™å°±ç·’";
        startBtn.style.display = "block";
      }
    };

    // è®“åŒä¸€æ™‚é–“åªæ’­æ”¾ä¸€æ”¯ï¼ˆé¿å…å¤šæ”¯ç–ŠéŸ³/è€—æ•ˆèƒ½ï¼‰
    let currentPlaying = null;
    const stopCurrent = () => {
      if (currentPlaying && !currentPlaying.paused) {
        currentPlaying.pause();
      }
      currentPlaying = null;
    };

    for (let i = 0; i < TOTAL; i++) {
      const fileId = (i + 1).toString().padStart(2, '0');

      // 1) Video asset
      const video = document.createElement('video');
      video.id = `v-${fileId}`;
      video.src = `./${fileId}.mp4`;
      video.setAttribute('preload', 'auto');
      video.setAttribute('loop', 'true');
      video.setAttribute('crossorigin', 'anonymous');
      video.setAttribute('webkit-playsinline', 'true');
      video.setAttribute('playsinline', 'true');
      video.muted = true; // iOS è‡ªå‹•æ’­æ”¾/è§£é–éœ€è¦
      assetContainer.appendChild(video);

      // 2) Target entity
      const targetEntity = document.createElement('a-entity');
      targetEntity.setAttribute('mindar-image-target', `targetIndex: ${i}`);

      const videoEntity = document.createElement('a-video');
      videoEntity.id = `ent-${fileId}`;
      videoEntity.setAttribute('src', `#v-${fileId}`);
      videoEntity.setAttribute('width', '1');
      videoEntity.setAttribute('height', '1');

      // âœ… é—œéµï¼šå…ˆä¸è¦æ¨ Zï¼Œä¿æŒ 0ï¼Œè·Ÿä½ ã€Œæ­£å¸¸ç‰ˆã€ä¸€è‡´
      videoEntity.setAttribute('position', '0 0 0');

      // âœ… é—œéµï¼šç”¨æè³ªè¨­å®šé¿å… z-fightingï¼ˆæ¯”æ¨ Z æ›´ç©©ï¼‰
      // shader: flat é¿å…å—å…‰å½±å½±éŸ¿ï¼›depthTest/depthWrite é—œæ‰é¿å…æ·±åº¦é–ƒçˆ/é»‘ç‰‡
      videoEntity.setAttribute('material', 'shader: flat; transparent: true; depthTest: false; depthWrite: false;');

      targetEntity.appendChild(videoEntity);
      targetsContainer.appendChild(targetEntity);

      // 3) loadedmetadata -> è¨­å®šæ¯”ä¾‹
      const onMeta = () => {
        const aspect = video.videoHeight / video.videoWidth;
        if (isFinite(aspect) && aspect > 0) {
          videoEntity.setAttribute('height', aspect);
        }
        checkReady();
        video.removeEventListener('loadedmetadata', onMeta);
      };
      video.addEventListener('loadedmetadata', onMeta);

      // æŸäº›ç€è¦½å™¨ metadata å·²å¯ç”¨
      if (video.readyState >= 1) {
        onMeta();
      }

      // 4) MindAR events
      targetEntity.addEventListener("targetFound", () => {
        console.log(`ğŸ¯ ç™¼ç¾ç›®æ¨™ ${fileId}`);
        scanGuide.style.display = "none";

        // åŒæ™‚é–“åªå…è¨±ä¸€æ”¯æ’­
        if (currentPlaying && currentPlaying !== video) stopCurrent();
        currentPlaying = video;

        // è§£é–å¾Œæ‰èƒ½ç©©æ’­ï¼ˆæœªè§£é–å°±å¿½ç•¥æ’­æ”¾æŒ‡ä»¤ï¼Œé¿å… iOS æ“‹ï¼‰
        if (!unlocked) return;

        video.muted = false;
        const p = video.play();
        if (p && typeof p.catch === "function") {
          p.catch(err => console.log("æ’­æ”¾å¤±æ•—:", err));
        }
      });

      targetEntity.addEventListener("targetLost", () => {
        console.log(`âŒ éºå¤±ç›®æ¨™ ${fileId}`);
        scanGuide.style.display = "block";
        video.pause();
        if (currentPlaying === video) currentPlaying = null;
      });
    }

    // å•Ÿå‹•æŒ‰éˆ•ï¼šè§£é–æ‰€æœ‰å½±ç‰‡æ’­æ”¾æ¬Šé™ï¼ˆiOS å¿…è¦ï¼‰
    startBtn.addEventListener('click', async () => {
      uiOverlay.style.display = "none";
      scanGuide.style.display = "block";

      const allVideos = document.querySelectorAll('video');
      for (const v of allVideos) {
        try {
          await v.play();
          v.pause();
          v.currentTime = 0;
        } catch (err) {
          console.log("å½±ç‰‡è§£é–å¤±æ•—:", err);
        }
      }
      unlocked = true;
      console.log("âœ… å½±éŸ³æ¬Šé™å·²è§£é–ï¼Œç­‰å¾…æƒæ");
    });
  </script>
</body>
</html>
